var pdfObjects={};function emptyDiv(a){var b=document.getElementById(a);while(b.hasChildNodes()){b.removeChild(b.lastChild)}}function createURL(b){var a=window.location.href;var c=a.split("/");if(c[2].match(/localhost.*/)){a=c[0]+"//"+c[2]+b}else{a=c[0]+"//"+c[2]+"/"+c[3]+b}return a}function loginForm(){var a=document.createElement("div");a.setAttribute("class","form");a.setAttribute("id","form-login");var d=document.createElement("input");d.setAttribute("type","text");d.setAttribute("name","username-login");d.setAttribute("maxlength","50");d.setAttribute("placeholder","User Name");var b=document.createElement("input");b.setAttribute("type","password");b.setAttribute("name","password-login");b.setAttribute("maxlength","32");b.setAttribute("placeholder","Password");var c=document.createElement("button");c.setAttribute("type","button");c.setAttribute("name","submit-login");c.setAttribute("onclick","login();");c.innerHTML="Log In";a.appendChild(d);a.appendChild(b);a.appendChild(c);return a}function signupForm(){var h=document.createElement("div");h.setAttribute("class","form");h.setAttribute("id","form-signup");var g=document.createElement("input");g.setAttribute("type","text");g.setAttribute("name","username-signup");g.setAttribute("maxlength","50");g.setAttribute("placeholder","User Name");var e=document.createElement("input");e.setAttribute("type","text");e.setAttribute("name","email-signup");e.setAttribute("maxlength","50");e.setAttribute("placeholder","Email - optional");var a=document.createElement("input");a.setAttribute("type","text");a.setAttribute("name","phone-signup");a.setAttribute("maxlength","15");a.setAttribute("placeholder","Phone - optional");var d=document.createElement("input");d.setAttribute("type","password");d.setAttribute("name","password-signup");d.setAttribute("maxlength","32");d.setAttribute("placeholder","Password");var c=document.createElement("input");c.setAttribute("type","password");c.setAttribute("name","password-signup-check");c.setAttribute("maxlength","32");c.setAttribute("placeholder","Repeat Password");var f=document.createElement("button");f.setAttribute("type","button");f.setAttribute("value","submit-signup");f.setAttribute("onclick","signup();");f.innerHTML="Sign Up";var b=document.createElement("div");b.setAttribute("class","error");b.setAttribute("id","error-signup");h.appendChild(g);h.appendChild(e);h.appendChild(a);h.appendChild(d);h.appendChild(c);h.appendChild(f);h.appendChild(b);return h}function displaySignUp(){var b=signupForm();var a=document.getElementById("content");a.appendChild(b);a.removeChild(document.getElementById("signupbtn"))}function logoutBtn(){var a=document.createElement("button");a.setAttribute("type","");a.setAttribute("class","menubtn logout-btn");a.setAttribute("value","submit-logout");a.setAttribute("onclick","logout();");a.innerHTML="Log Out";return a}function profileBtn(){var a=createURL("/profile");var b=document.createElement("a");b.setAttribute("class","profile-btn");b.setAttribute("href",a);b.setAttribute("target","_blank");b.setAttribute("value","Profile");b.innerHTML="Profile";return b}function saveBar(){var a=document.createElement("div");a.setAttribute("id","savebar");return a}function saveStatusDisplay(){var a=document.createElement("div");a.setAttribute("id","savestatus");a.innerHTML="Saved";return a}function autoSaveDisplay(){var a=document.createElement("div");a.setAttribute("id","autosave");return a}function saveProgressDisplay(){var b=document.createElement("div");b.setAttribute("id","saveprogress");b.style.visibility="hidden";b.style.display="none";var a=document.createElement("progress");a.setAttribute("value",100);a.setAttribute("max",100);b.appendChild(a);return b}function initializeProgress(a){document.getElementById("saveinfo").style.visibility="hidden";document.getElementById("saveinfo").style.display="none";document.getElementById("saveprogress").childNodes[0].setAttribute("value",0);document.getElementById("saveprogress").childNodes[0].setAttribute("max",a);document.getElementById("saveprogress").style.visibility="visible";document.getElementById("saveprogress").style.display="block"}function updateProgress(a){document.getElementById("saveprogress").childNodes[0].setAttribute("value",a)}function finalizeProgress(a){document.getElementById("saveprogress").childNodes[0].setAttribute("value",a);document.getElementById("saveprogress").style.visibility="hidden";document.getElementById("saveprogress").style.display="none";document.getElementById("saveinfo").style.visibility="visible";document.getElementById("saveinfo").style.display="block"}function profileRow(f,g,c){var i=document.createElement("div");i.setAttribute("class","row");var h=document.createElement("div");h.setAttribute("class","col col-15");var e=document.createElement("div");e.setAttribute("class","col col-70 pad-10");var b=document.createElement("div");b.setAttribute("class","col col-15");var a=document.createElement("input");a.setAttribute("type","text");a.setAttribute("name",f);a.setAttribute("class","text-input");a.setAttribute("maxlength","50");a.setAttribute("value",c);var d=document.createElement("button");d.setAttribute("type","button");d.setAttribute("name","save-"+f);d.setAttribute("class","menubtn save-btn");d.setAttribute("onclick",'saveProfileInfo(this,["'+f+'"])');d.innerHTML="Save";h.innerHTML=g;e.appendChild(a);b.appendChild(d);i.appendChild(h);i.appendChild(e);i.appendChild(b);return i}function profileRowCheck(a,i,h,j){var l=document.createElement("div");l.setAttribute("class","row");var k=document.createElement("div");k.setAttribute("class","col col-15");var d=document.createElement("div");d.setAttribute("class","col col-35 pad-10-left");var f=document.createElement("div");f.setAttribute("class","col col-35 pad-10-right");var c=document.createElement("div");c.setAttribute("class","col col-15");var e=document.createElement("input");e.setAttribute("type","password");e.setAttribute("name",a);e.setAttribute("class","text-input");e.setAttribute("maxlength","50");e.setAttribute("placeholder",h[0]);var b=document.createElement("input");b.setAttribute("type","password");b.setAttribute("name",i);b.setAttribute("class","text-input");b.setAttribute("maxlength","50");b.setAttribute("placeholder",h[1]);var g=document.createElement("button");g.setAttribute("type","button");g.setAttribute("name","save-"+i);g.setAttribute("class","menubtn save-btn");g.setAttribute("onclick",'saveProfileInfo(this,["'+a+'","'+i+'"])');g.innerHTML="Save";k.innerHTML=j;d.appendChild(e);f.appendChild(b);c.appendChild(g);l.appendChild(k);l.appendChild(d);l.appendChild(f);l.appendChild(c);return l}function displayLanding(){var b=loginForm();var c=document.createElement("button");c.setAttribute("type","button");c.setAttribute("id","signupbtn");c.setAttribute("onclick","displaySignUp();");c.innerHTML="Sign Up";var a=document.getElementById("content");a.appendChild(b);a.appendChild(document.createElement("hr"));a.appendChild(c)}function displayHome(){var b=logoutBtn();var f=document.createElement("div");f.setAttribute("class","form");f.setAttribute("id","form-header");var e=document.createElement("input");e.setAttribute("type","text");e.setAttribute("name","pagename-create");e.setAttribute("maxlength","50");e.setAttribute("placeholder","Page Name");var c=document.createElement("button");c.setAttribute("type","button");c.setAttribute("value","submit-createpage");c.setAttribute("onclick","createpage();");c.innerHTML="Create Page";f.appendChild(b);f.appendChild(e);f.appendChild(c);var a=document.getElementById("content");a.appendChild(b);a.appendChild(f);var d=getPages();d.then(function(g){var h=g.split(",");var m=document.createElement("div");m.setAttribute("class","pagelist");var l;if(h.length===1){l=0}else{l=h.length/2}var j=0;while(l>0){var k=document.createElement("a");k.setAttribute("class","pagelink");k.setAttribute("href","editpage?page="+h[j]);k.setAttribute("target","_blank");k.innerHTML=h[j+1];m.appendChild(k);j+=2;l--}a.appendChild(document.createElement("hr"));a.appendChild(m)},function(g){console.log("getPages promise error")})}function errorPage(c){var b=document.createElement("div");if(c=="noeditloggedout"){b.innerHTML="You Cannot Edit The Requested Page Because You Are Logged Out."}else{if(c=="notfound"){b.innerHTML="There URL You Requested Does Not Exist"}}var a=document.getElementById("content");a.appendChild(b)}function editPage(y){var P=document.createElement("div");P.setAttribute("class","block-menu");var k=document.createElement("div");k.setAttribute("class","row");var E=document.createElement("div");E.setAttribute("class","col col-15");var O=document.createElement("div");O.setAttribute("class","col col-70 pad-10");var x=document.createElement("div");x.setAttribute("class","col col-15");k.appendChild(E);k.appendChild(O);k.appendChild(x);var t=logoutBtn();var q=saveBar();var s=saveProgressDisplay();var p=saveStatusDisplay();var H=autoSaveDisplay();var w=document.createElement("div");w.setAttribute("id","saveinfo");w.appendChild(p);w.appendChild(H);q.appendChild(s);q.appendChild(w);var g=profileBtn();var F=y.split(",");var G=F[0];var L=F[1];var z=document.createElement("input");z.setAttribute("type","hidden");z.setAttribute("name","pageid");z.setAttribute("value",G);var T=document.createElement("input");T.setAttribute("type","hidden");T.setAttribute("name","statusid");T.setAttribute("value","1");E.appendChild(t);O.appendChild(q);x.appendChild(g);P.appendChild(z);P.appendChild(T);P.appendChild(k);var C=document.createElement("div");C.setAttribute("class","row");var A=document.createElement("div");A.setAttribute("class","col col-15");var I=document.createElement("div");I.setAttribute("class","col col-70 pad-10");var b=document.createElement("div");b.setAttribute("class","col col-15");C.appendChild(A);C.appendChild(I);C.appendChild(b);var R=document.createElement("button");R.setAttribute("type","button");R.setAttribute("name","revert-blocks");R.setAttribute("class","menubtn revert-btn");R.setAttribute("onclick","revertBlocks()");R.innerHTML="Revert";var D=document.createElement("input");D.setAttribute("type","text");D.setAttribute("name","pagename");D.setAttribute("class","page-title");D.setAttribute("maxlength","50");D.setAttribute("value",L);var h=document.createElement("button");h.setAttribute("type","button");h.setAttribute("name","save-blocks");h.setAttribute("class","menubtn save-btn");h.setAttribute("onclick","saveBlocks(true)");h.innerHTML="Save";A.appendChild(R);I.appendChild(D);b.appendChild(h);P.appendChild(C);var v=document.createElement("div");v.setAttribute("class","blocks");v.setAttribute("id","blocks");var B=blockButtons(0);v.appendChild(B);var K=2;var M=1;while(K<F.length){var l=insertContent(M,F[K],F[K+1]);B=blockButtons(M);var u=document.createElement("div");u.setAttribute("class","block");u.setAttribute("id",M);u.appendChild(l);u.appendChild(B);v.appendChild(u);K+=2;M++}var f=document.createElement("input");f.setAttribute("type","file");f.setAttribute("id","file-select");var S=document.createElement("button");S.setAttribute("type","submit");S.setAttribute("id","upload-button");var e=createURL("/uploadmedia");var a=document.createElement("form");a.setAttribute("id","file-form");a.setAttribute("action",e);a.setAttribute("method","POST");a.style.visibility="hidden";a.appendChild(f);a.appendChild(S);var d=document.getElementById("content");d.appendChild(P);d.appendChild(v);d.appendChild(a);M=0;var c=countBlocks();while(M<c){document.getElementById("d"+M).style.visibility="visible";M++}document.getElementById("d"+M).style.visibility="hidden";var J=document.getElementsByClassName("xTex");var j=J.length;for(M=0;M<j;M++){J[M].contentDocument.designMode="on"}var N=document.getElementsByTagName("code");var r=N.length;for(M=0;M<r;M++){renderCode(N[M])}var o=document.getElementsByClassName("xmath");var m=o.length;for(M=0;M<m;M++){insertMath(o[M])}var Q=document.getElementsByClassName("latex");var n=Q.length;for(M=0;M<n;M++){insertLatex(Q[M])}autosaveTimer(H);window.onbeforeunload=function(){var i=document.getElementsByName("statusid")[0].value;if(i==0){return"Please click Revert or Save before exiting."}return null}}function choosePage(f){var j=document.createElement("div");j.setAttribute("class","row");var h=document.createElement("div");h.setAttribute("class","col col-100 pad-10");var i=document.createElement("p");i.innerHTML="You are viewing this because the page was closed without Revert or Save being clicked. Please choose which page you want to save.";h.appendChild(i);j.appendChild(h);var c=document.createElement("div");c.setAttribute("class","row");var l=document.createElement("div");l.setAttribute("class","col col-50 pad-10");var b=document.createElement("div");b.setAttribute("class","col col-50 pad-10");c.appendChild(l);c.appendChild(b);var k=document.createElement("p");k.innerHTML="This is your last temporary save. This save contains the blocks from the last time you added a block.";var e=document.createElement("button");e.setAttribute("type","button");e.setAttribute("class","menubtn temp-btn");e.setAttribute("value","submit-temp");e.setAttribute("onclick","loadTempPage("+f+");");e.innerHTML="Temporary Page";var a=document.createElement("p");a.innerHTML="This is you last permanent save. This save contains the blocks from the last time you clicked Save.";var g=document.createElement("button");g.setAttribute("type","button");g.setAttribute("class","menubtn perm-btn");g.setAttribute("value","submit-perm");g.setAttribute("onclick","loadPermPage("+f+");");g.innerHTML="Permanent Page";l.appendChild(e);l.appendChild(k);b.appendChild(g);b.appendChild(a);var d=document.getElementById("content");d.appendChild(j);d.appendChild(c)}function loadTempPage(a){var b=createURL("/editpage?page="+a+"&temp=true");window.location=b}function loadPermPage(a){var b=createURL("/editpage?page="+a+"&temp=false");window.location=b}function profilePage(b){if(b=="err"){console.log("profile error")}else{if(b=="noprofileloggedout"){console.log("profile logged out")}}var m=JSON.parse(b);var c=document.createElement("div");c.setAttribute("class","block-menu");var a=document.createElement("div");a.setAttribute("class","row");var j=document.createElement("div");j.setAttribute("class","col col-15");var h=document.createElement("div");h.setAttribute("class","col col-70 pad-10");var n=document.createElement("div");n.setAttribute("class","col col-15");a.appendChild(j);a.appendChild(h);a.appendChild(n);var o=logoutBtn();j.appendChild(o);c.appendChild(a);var f=document.createElement("div");f.setAttribute("class","profilelist");var l=profileRow("username","Username:",m.username);var e=profileRowCheck("currentPass","newPass",["Current Password","New Password"],"Password:");var d=profileRow("autosave","Auto Save:",m.autosave);var k=profileRow("email","Email:",m.email);var i=profileRow("phone","Phone:",m.phone);f.appendChild(l);f.appendChild(e);f.appendChild(d);f.appendChild(k);f.appendChild(i);var g=document.getElementById("content");g.appendChild(c);g.appendChild(f)}function countBlocks(){var a=0;var b=true;while(b==true){a++;b=Boolean(document.getElementById(a))}return --a}function generateBlock(a,c){var b=document.createElement("div");b.setAttribute("class",c);b.setAttribute("id","a"+a);return b}function insertContent(i,d,o){var f=generateBlock(i,d);if(d==="xtext"){var k=document.createElement("iframe");k.setAttribute("class","xTex");k.setAttribute("maxlength","1023");f.appendChild(k);setTimeout(function(){var r=document.createElement("link");r.href="http://abaganon.com/css/block.css";r.rel="stylesheet";r.type="text/css";var s=f.childNodes[0].contentDocument;s.open();s.write(o);s.close();f=f.childNodes[0];if(s.addEventListener){s.addEventListener("keydown",detectKey.bind(null,f),false)}else{if(s.attachEvent){s.attachEvent("onkeydown",detectKey.bind(null,f))}else{s.onkeydown=detectKey.bind(null,f)}}},1)}else{if(d==="xcode"){var q=document.createElement("code");q.setAttribute("class","xCde");q.setAttribute("onblur","renderCode(this)");q.contentEditable="true";q.innerHTML=o;f.appendChild(q);if(q.addEventListener){q.addEventListener("keydown",codeKeys.bind(null,f),false)}else{if(q.attachEvent){q.attachEvent("onkeydown",codeKeys.bind(null,f))}else{q.onkeydown=codeKeys.bind(null,f)}}}else{if(d==="xmath"){var l='<div class="mathImage"></div>';var g='<div class="xMat" onblur="renderMath(this);" contenteditable>'+o+"</code>";f.innerHTML=l+g}else{if(d==="latex"){var n='<div class="latexImage"></div>';var j='<div class="xLtx" onblur="renderLatex(this);" contenteditable>'+o+"</code>";f.innerHTML=n+j}else{if(d==="image"){var b=document.createElement("img");b.setAttribute("class","xImg");b.src=o;f.appendChild(b)}else{if(d==="audio"){var h=document.createElement("audio");h.setAttribute("class","xAud");h.volume=0.8;h.setAttribute("controls","controls");var e=document.createElement("source");e.setAttribute("src",o);e.setAttribute("type","audio/mpeg");h.appendChild(e);f.appendChild(h)}else{if(d==="video"){var a=document.createElement("video");a.setAttribute("class","xVid");a.volume=0.8;a.setAttribute("controls","controls");var m=document.createElement("source");m.setAttribute("src",o);m.setAttribute("type","video/mp4");a.appendChild(m);f.appendChild(a)}else{if(d==="slide"){var c=document.createElement("canvas");c.setAttribute("class","xSli");c.setAttribute("id",o);c.setAttribute("data-page","1");f.appendChild(c);if(o!==""){PDFJS.getDocument(o).then(function(s){pdfObjects[o]=s;var r=f.childNodes[0];renderPDF(s,1,r)})}f.onmouseup=function(t){var w=t.pageX-this.offsetLeft;var s=this.childNodes[0];var u=s.getAttribute("data-page");var v=s.getAttribute("id");var r=pdfObjects[v].numPages;if(w>this.offsetWidth/1.7){if(u<r){u++;s.setAttribute("data-page",u);renderPDF(pdfObjects[v],u,s)}}else{if(u>1){u--;s.setAttribute("data-page",u);renderPDF(pdfObjects[v],u,s)}}}}else{if(d==="title"){var p='<input type="text" class="xTit" maxlength="64" value="'+o+'">';f.innerHTML=p}}}}}}}}}return f}function codeKeys(e,b){if(b.keyCode===9){b.preventDefault();var d=e.ownerDocument.defaultView;var c=d.getSelection();var a=c.getRangeAt(0);var f=document.createTextNode("\u00a0\u00a0\u00a0\u00a0");a.insertNode(f);a.setStartAfter(f);a.setEndAfter(f);c.removeAllRanges();c.addRange(a)}}function detectKey(a,b){if(b.shiftKey&&b.ctrlKey&&b.keyCode==66){a.contentDocument.execCommand("bold",false,null)}if(b.shiftKey&&b.ctrlKey&&b.keyCode==73){a.contentDocument.execCommand("italic",false,null)}if(b.shiftKey&&b.ctrlKey&&b.keyCode==76){a.contentDocument.execCommand("insertUnorderedList",false,null)}if(b.shiftKey&&b.ctrlKey&&b.keyCode==187){a.contentDocument.execCommand("superscript",false,null)}if(b.shiftKey&&b.ctrlKey&&b.keyCode==189){a.contentDocument.execCommand("subscript",false,null)}if(b.shiftKey&&b.ctrlKey&&b.keyCode==74){a.contentDocument.execCommand("justifyLeft",false,null)}if(b.shiftKey&&b.ctrlKey&&b.keyCode==70){a.contentDocument.execCommand("justifyFull",false,null)}if(b.keyCode==9){a.contentDocument.execCommand("insertHTML",false,"&nbsp;&nbsp;&nbsp;&nbsp;")}if(b.shiftKey&&b.ctrlKey&&b.keyCode==72){var c=function(d,e){if(d){if(e.indexOf("http://")<0&&e.indexOf("https://")<0){a.contentDocument.execCommand("createLink",false,"http://"+e)}else{if(e.indexOf("http://")>0||e.indexOf("https://")>0){a.contentDocument.execCommand("createLink",false,e)}else{alertify.log("Not A Valid Link!","error")}}}else{}};alertify.prompt("Enter the link: ",c,"http://")}b.stopPropagation()}function renderCode(a){hljs.highlightBlock(a);if(a.textContent.length>1024){alertify.alert("There is too much in this code block. The block will not save correctly. Please remove some of its content.")}}function renderMath(c){var b="`"+c.textContent+"`";var a=c.parentNode.childNodes[0];a.innerHTML=b;MathJax.Hub.Queue(["Typeset",MathJax.Hub,a])}function renderLatex(c){var b="$$"+c.textContent+"$$";var a=c.parentNode.childNodes[0];a.innerHTML=b;MathJax.Hub.Queue(["Typeset",MathJax.Hub,a])}function renderPDF(a,c,b){var d=0.8;a.getPage(c).then(function(h){var e=h.getViewport(d);b.height=e.height;b.width=e.width;var g={canvasContext:b.getContext("2d"),viewport:e};var f=h.render(g);f.promise.then(function(){})})}function insertMath(c){var b="`"+c.childNodes[1].textContent+"`";var a=c.childNodes[0];a.innerHTML=b;MathJax.Hub.Queue(["Typeset",MathJax.Hub,a])}function insertLatex(c){var b="$$"+c.childNodes[1].textContent+"$$";var a=c.childNodes[0];a.innerHTML=b;MathJax.Hub.Queue(["Typeset",MathJax.Hub,a])}function blockButtons(e){var i=document.createElement("div");i.setAttribute("class","blockbtns");i.setAttribute("id","b"+e);var a=document.createElement("button");a.setAttribute("onclick","addBlock("+e+",'xtext')");a.setAttribute("class","blockbtn addbtn");a.innerHTML="text";var f=document.createElement("button");f.setAttribute("onclick","addBlock("+e+",'xcode')");f.setAttribute("class","blockbtn addbtn");f.innerHTML="code";var l=document.createElement("button");l.setAttribute("onclick","addBlock("+e+",'xmath')");l.setAttribute("class","blockbtn addbtn");l.innerHTML="math";var k=document.createElement("button");k.setAttribute("onclick","addBlock("+e+",'latex')");k.setAttribute("class","blockbtn addbtn");k.innerHTML="latex";var b=document.createElement("button");b.setAttribute("onclick","addBlock("+e+",'image')");b.setAttribute("class","blockbtn addbtn");b.innerHTML="image";var h=document.createElement("button");h.setAttribute("onclick","addBlock("+e+",'audio')");h.setAttribute("class","blockbtn addbtn");h.innerHTML="audio";var c=document.createElement("button");c.setAttribute("onclick","addBlock("+e+",'video')");c.setAttribute("class","blockbtn addbtn");c.innerHTML="video";var g=document.createElement("button");g.setAttribute("onclick","addBlock("+e+",'slide')");g.setAttribute("class","blockbtn addbtn");g.innerHTML="slides";var d=document.createElement("button");d.setAttribute("onclick","addBlock("+e+",'title')");d.setAttribute("class","blockbtn addbtn");d.innerHTML="title";var j=document.createElement("button");j.setAttribute("id","d"+e);j.setAttribute("onclick","deleteBlock("+e+")");j.setAttribute("class","blockbtn delbtn");j.style.visibility="hidden";j.innerHTML="&darr;";i.appendChild(a);i.appendChild(f);i.appendChild(l);i.appendChild(k);i.appendChild(b);i.appendChild(h);i.appendChild(c);i.appendChild(g);i.appendChild(d);i.appendChild(j);return i}function makeSpace(b,e){var a=e;while(b<a){var c=a+1;var d=blockButtons(c);document.getElementById("b"+a).parentNode.replaceChild(d,document.getElementById("b"+a));document.getElementById("a"+a).setAttribute("id","a"+c);document.getElementById(a).setAttribute("id",c);a--}}function insertBlock(g,d,b,c){var f=document.getElementById("blocks");var e=document.createElement("div");e.setAttribute("class","block");e.setAttribute("id",b);e.appendChild(g);e.appendChild(d);if(b<=c){var a=document.getElementById("blocks").children[b];document.getElementById("blocks").insertBefore(e,a)}else{f.appendChild(e)}}function createBlock(c,h){var f=countBlocks();if(c<f){makeSpace(c,f)}var b=c+1;var e="";var g=insertContent(b,h,e);var a=blockButtons(b);insertBlock(g,a,b,f);var d=0;while(d<=f){document.getElementById("d"+d).style.visibility="visible";d++}}function addBlock(a,d){if(d==="xtext"){createBlock(a,d);var c=document.getElementById("a"+(a+1)).childNodes[0];var b=c.contentDocument;b.designMode="on";saveBlocks(false)}else{if(["xcode","xmath","latex","title"].indexOf(d)>-1){createBlock(a,d);saveBlocks(false)}else{if(["image","audio","video","slide"].indexOf(d)>-1){uploadMedia(a+1,d)}}}}function closeSpace(b,e){var a=b;while(a<e){var c=a+1;var d=blockButtons(a);document.getElementById("b"+c).parentNode.replaceChild(d,document.getElementById("b"+c));document.getElementById("a"+c).setAttribute("id","a"+a);document.getElementById(c).setAttribute("id",a);a++}}function removeBlock(a){var b=document.getElementById(a);b.parentNode.removeChild(b)}function deleteBlock(b){var d=countBlocks();var a=b+1;removeBlock(a);if(a<d){closeSpace(a,d)}var c=0;d=countBlocks();while(c<d){document.getElementById("d"+c).style.visibility="visible";c++}document.getElementById("d"+c).style.visibility="hidden";saveBlocks(false)}function uploadMedia(b,c){var a=document.getElementById("file-select");a.click();a.onchange=function(){var d=a.files[0];var f=false;if(f){alertify.alert("Invalid File Format")}else{createBlock(b-1,c);var e=new Promise(function(m,l){var n=new FormData();n.append("media",d,d.name);var i=document.getElementsByName("pageid")[0].value;var j=createURL("/uploadmedia?pid="+i+"&btype="+c);var k=new XMLHttpRequest();k.open("POST",j,true);k.upload.onprogress=function(o){if(o.lengthComputable){updateProgress(o.loaded)}};k.upload.onloadstart=function(o){initializeProgress(o.total)};k.upload.onloadend=function(o){finalizeProgress(o.total)};function h(o){if(typeof h.track==="undefined"||h.track===0){h.track=1;return 1}else{if(o){h.track=0;return 0}else{h.track++}}return h.track}function g(o){if(typeof g.prev==="undefined"){g.prev=0;g.curr=o}else{if(g.curr!==o){g.prev=g.curr;g.curr=o}}return[g.prev,g.curr]}k.onprogress=function(q){var o=g(k.responseText.length);var p=h(false);if(p===1){initializeProgress(k.responseText.slice(o[0],o[1]))}else{updateProgress(k.responseText.slice(o[0],o[1]))}};k.onloadend=function(p){var o=g(k.responseText.length);finalizeProgress(k.responseText.slice(o[0],o[1]));h(true)};k.onreadystatechange=function(){if(k.readyState==XMLHttpRequest.DONE){if(k.status==200){if(k.responseText=="err"){l("err")}else{if(k.responseText=="convertmediaerr"){l("convertmediaerr")}else{if(k.responseText=="nouploadloggedout"){deleteBlock(b-1);alertify.alert("You Can't Upload Media Because You Are Logged Out. Log Back In On A Separate Page, Then Return Here & Try Again.");l("err")}else{var o=g(k.responseText.length);m(k.responseText.slice(o[0],o[1]));g(0);g(0)}}}}else{alertify.alert("Error:"+k.status+": Please Try Again");l("err")}}};k.send(n)});e.then(function(i){if(c==="image"){var h=document.getElementById("a"+b).childNodes[0];h.src=i}else{if(c==="audio"||c==="video"){var g=document.getElementById("a"+b).childNodes[0].childNodes[0];g.src=i;g.parentNode.load()}else{if(c==="slide"){PDFJS.getDocument(i).then(function(j){pdfObjects[i]=j;var k=document.getElementById("a"+b).childNodes[0];k.setAttribute("id",i);renderPDF(j,1,k)})}}}saveBlocks(false)},function(g){if(g==="convertmediaerr"){alertify.log("There was an error with that media format. Please try a different file type.")}else{console.log("uploadMedia() promise error")}})}}}function login(){var b=createURL("/login");var e=document.getElementsByName("username-login")[0].value;var a=document.getElementsByName("password-login")[0].value;var c;c=new XMLHttpRequest();var d="username="+e+"&password="+a;c.open("POST",b,true);c.setRequestHeader("Content-type","application/x-www-form-urlencoded");c.onreadystatechange=function(){if(c.readyState==XMLHttpRequest.DONE){if(c.status==200){if(c.responseText=="loggedin"){emptyDiv("content");displayHome()}else{if(c.responseText=="incorrect"){alertify.alert("The Passowrd Was Incorrect")}else{if(c.responseText=="notfound"){alertify.alert("The Username Could Not Be Found")}else{alertify.alert("An Unknown Error Occurred")}}}}else{alertify.alert("Error:"+c.status+": Please Try Again Later")}}};c.send(d)}function signup(){var d=createURL("/signup");var h=document.getElementsByName("username-signup")[0].value;var c=document.getElementsByName("email-signup")[0].value;var a=document.getElementsByName("phone-signup")[0].value;var b=document.getElementsByName("password-signup")[0].value;var f=document.getElementsByName("password-signup-check")[0].value;if(b!==f){}var e;e=new XMLHttpRequest();var g="username="+h+"&email="+c+"&phone="+a+"&password="+b;e.open("POST",d,true);e.setRequestHeader("Content-type","application/x-www-form-urlencoded");e.onreadystatechange=function(){if(e.readyState==XMLHttpRequest.DONE){if(e.status==200){if(e.responseText=="success"){emptyDiv("content");displayHome()}else{if(e.responseText=="exists"){alertify.alert("That Username Already Exists.\nPlease Choose A Different One.")}else{alertify.alert("An Unknown Error Occurred")}}}else{alertify.alert("Error:"+e.status+": Please Try Again Later")}}};e.send(g)}function logout(){var a=createURL("/logout");var b;b=new XMLHttpRequest();b.open("POST",a,true);b.setRequestHeader("Content-type","application/x-www-form-urlencoded");b.onreadystatechange=function(){if(b.readyState==XMLHttpRequest.DONE){if(b.status==200){if(b.responseText=="loggedout"){emptyDiv("content");displayLanding()}else{alertify.alert("An Unknown Error Occurred")}}else{alertify.alert("Error:"+b.status+": Please Try Again Later")}}};b.send()}function createpage(){var b=createURL("/createpage");var a=document.getElementsByName("pagename-create")[0].value;var c;c=new XMLHttpRequest();var d="pagename="+a;c.open("POST",b,true);c.setRequestHeader("Content-type","application/x-www-form-urlencoded");c.onreadystatechange=function(){if(c.readyState==XMLHttpRequest.DONE){if(c.status==200){if(c.responseText=="pageexists"){alertify.alert("You Already Have A Page With That Name.")}else{if(c.responseText=="nocreateloggedout"){alertify.alert("Unable To Create Page. You Are Logged Out.")}else{if(c.responseText=="err"){alertify.alert("An Error Occured. Please Try Again Later.")}else{window.location=createURL("/editpage?page="+c.responseText)}}}}else{alertify.alert("Error:"+c.status+": Please Try Again Later")}}};c.send(d)}function getPages(){var a=new Promise(function(e,d){var b=createURL("/getpages");var c;c=new XMLHttpRequest();c.open("POST",b,true);c.setRequestHeader("Content-type","application/x-www-form-urlencoded");c.onreadystatechange=function(){if(c.readyState==XMLHttpRequest.DONE){if(c.status==200){if(c.responseText=="err"){d("err")}else{e(c.responseText)}}else{alertify.alert("Error:"+c.status+": Please Try Again Later")}}};c.send()});return a}function saveBlocks(g){var p;if(g===false){p=0;document.getElementById("savestatus").innerHTML="Not Saved"}else{p=1;document.getElementById("savestatus").innerHTML="Saved"}document.getElementsByName("statusid")[0].setAttribute("value",p);var r=[];var e=[];var l=countBlocks();var o=1;if(l>0){var m=0;while(l>=o){var k=document.getElementById("a"+o).className;r[m]=k;if(k=="xtext"){e[m]=document.getElementById("a"+o).children[0].contentDocument.getElementsByTagName("body")[0].innerHTML;e[m]=e[m].replace(/'/g," ").replace(/,/g," ").replace(/&/g," ")}else{if(k=="xcode"){e[m]=document.getElementById("a"+o).children[0].textContent;e[m]=e[m].replace(/'/g," ").replace(/,/g," ").replace(/&/g," ")}else{if(k=="latex"||k=="xmath"){e[m]=document.getElementById("a"+o).children[1].innerHTML.replace(/\\/g,"\\\\");e[m]=e[m].replace(/'/g," ").replace(/,/g," ").replace(/&/g," ")}else{if(k==="image"){var a=document.getElementById("a"+o).children[0].src;e[m]=a.replace(location.href.substring(0,location.href.lastIndexOf("/")+1),"")}else{if(k==="audio"||k==="video"){var h=document.getElementById("a"+o).children[0].children[0].src;e[m]=h.replace(location.href.substring(0,location.href.lastIndexOf("/")+1),"")}else{if(k==="slide"){var c=document.getElementById("a"+o).children[0].id;e[m]=c.replace(location.href.substring(0,location.href.lastIndexOf("/")+1),"")}else{if(k==="title"){e[m]=document.getElementById("a"+o).children[0].value;e[m]=e[m].replace(/'/g," ").replace(/,/g," ").replace(/&/g," ")}}}}}}}m++;o++}var f=r.join();var n=e.join()}var d=createURL("/saveblocks");var j=document.getElementsByName("pageid")[0].value;var b=document.getElementsByName("pagename")[0].value;var s;s=new XMLHttpRequest();s.upload.onprogress=function(i){if(i.lengthComputable){document.getElementById("saveprogress").childNodes[0].setAttribute("value",i.loaded);document.getElementById("saveprogress").childNodes[0].setAttribute("max",i.total)}};s.upload.onloadstart=function(i){document.getElementById("saveinfo").style.visibility="hidden";document.getElementById("saveinfo").style.display="none";document.getElementById("saveprogress").childNodes[0].setAttribute("value",0);document.getElementById("saveprogress").style.visibility="visible";document.getElementById("saveprogress").style.display="block"};s.upload.onloadend=function(i){document.getElementById("saveprogress").childNodes[0].setAttribute("value",i.total);document.getElementById("saveprogress").style.visibility="hidden";document.getElementById("saveprogress").style.display="none";document.getElementById("saveinfo").style.visibility="visible";document.getElementById("saveinfo").style.display="block"};var q="mediaType="+f+"&mediaContent="+n+"&pid="+j+"&pagename="+b+"&tabid="+p;s.open("POST",d,true);s.setRequestHeader("Content-type","application/x-www-form-urlencoded");s.onreadystatechange=function(){if(s.readyState==XMLHttpRequest.DONE){if(s.status==200){if(s.responseText=="blockssaved"){}else{if(s.responseText=="nosaveloggedout"){alertify.alert("You Can't Save This Page Because You Are Logged Out. Log In On A Separate Page, Then Return Here & Try Again.")}else{alertify.alert("An Unknown Error Occurred")}}}else{alertify.alert("Error:"+s.status+": Please Try Again Later")}}};s.send(q)}function revertBlocks(){var c=createURL("/revert");var a=document.getElementsByName("pageid")[0].value;var b=document.getElementsByName("pagename")[0].value;var d;d=new XMLHttpRequest();var e="pid="+a;d.open("POST",c,true);d.setRequestHeader("Content-type","application/x-www-form-urlencoded");d.onreadystatechange=function(){if(d.readyState==XMLHttpRequest.DONE){if(d.status==200){if(d.responseText=="nopid"){alertify.alert("This Page Is Not Meant To Be Visited Directly.")}else{if(d.responseText=="norevertloggedout"){alertify.alert("Revert Error. You Are Not Logged In.")}else{if(d.responseText=="err"){alertify.alert("An Error Occured. Please Try Again Later")}else{emptyDiv("content");editPage(a+","+b+d.responseText)}}}}else{alertify.alert("Error:"+d.status+": Please Try Again Later")}}};d.send(e)}function saveProfileInfo(e,a){var g="";var d=0;var f=a.length;if(f>0){g=a[d]+"="+document.getElementsByName(a[d])[0].value;d++}while(d<f){g+="&"+a[d]+"="+document.getElementsByName(a[d])[0].value;d++}var b=createURL("/saveprofile");var c;c=new XMLHttpRequest();c.open("POST",b,true);c.setRequestHeader("Content-type","application/x-www-form-urlencoded");c.onreadystatechange=function(){if(c.readyState==XMLHttpRequest.DONE){if(c.status==200){if(c.responseText=="profilesaved"){e.style="background-color: #00ffe1";alertify.log("Saved!","success")}else{if(c.responseText=="nosaveloggedout"){e.style="background-color: #e83e3e";alertify.alert("You Can't Save Because You Are Logged Out. Log In On A Separate Page, Then Return Here & Try Again.")}else{e.style="background-color: #e83e3e";alertify.alert("An Unknown Error Occurred")}}}else{alertify.alert("Error:"+c.status+": Please Try Again Later")}}};c.send(g)}function autosaveTimer(a){var b=getUserFields(["autosave"]);b.then(function(d){var e=d.autosave;if(e!=0){var g=e;var c;var f;setInterval(function(){c=parseInt(g/60,10);f=parseInt(g%60,10);c=c<10?"0"+c:c;f=f<10?"0"+f:f;a.textContent=c+":"+f;if(--g<0){saveBlocks(true);g=e}},1000)}else{a.style.visibility="hidden";a.style.display="none"}},function(c){alertify.alert("Error. Auto Save Could Not Be Initiated.")})}function getUserFields(a){var b=new Promise(function(f,e){var g="fields="+a.join(",");var c=createURL("/getprofiledata");var d;d=new XMLHttpRequest();d.open("POST",c,true);d.setRequestHeader("Content-type","application/x-www-form-urlencoded");d.onreadystatechange=function(){if(d.readyState==XMLHttpRequest.DONE){if(d.status==200){if(d.responseText=="err"){e("err")}else{if(d.responseText=="noprofiledataloggedout"){e("noprofiledataloggedout")}else{f(JSON.parse(d.responseText))}}}else{e("err")}}};d.send(g)});return b};