var pdfObjects={};function createURL(b){var a=window.location.href;var c=a.split("/");if(c[2].match(/localhost.*/)){a=c[0]+"//"+c[2]+b}else{a=c[0]+"//"+c[2]+"/"+c[3]+b}return a}function emptyDiv(a){var b=document.getElementById(a);while(b.hasChildNodes()){b.removeChild(b.lastChild)}}function goToPage(){var b=document.getElementById("page-select");var a=createURL("/editpage?page="+b.value);window.open(a,"_blank")}function btnLogOut(){var a=document.createElement("button");a.setAttribute("type","");a.setAttribute("class","menubtn logout-btn");a.setAttribute("value","submit-logout");a.setAttribute("onclick","logout();");a.innerHTML="Log Out";return a}function btnProfile(){var a=createURL("/profile");var b=document.createElement("a");b.setAttribute("class","profile-btn");b.setAttribute("href",a);b.setAttribute("target","_blank");b.setAttribute("value","Profile");b.innerHTML="Profile";return b}function btnSubmit(c,b){var a=document.createElement("button");a.setAttribute("type","");a.setAttribute("class","menubtn generic-btn");a.setAttribute("value","submit");a.setAttribute("onclick",b+"();");a.innerHTML=c;return a}function dashAutoSave(){var a=document.createElement("div");a.setAttribute("id","autosave");return a}function dashSaveBar(){var a=document.createElement("div");a.setAttribute("id","savebar");return a}function dashSaveStatus(){var a=document.createElement("div");a.setAttribute("id","savestatus");a.innerHTML="Saved";return a}function dashSaveProgress(){var b=document.createElement("div");b.setAttribute("id","saveprogress");var a=document.createElement("progress");a.setAttribute("id","progressbar");a.setAttribute("value",100);a.setAttribute("max",100);a.style.visibility="hidden";a.style.display="none";b.appendChild(a);return b}function displaySignUp(){var b=formSignUp();var a=document.getElementById("content");a.appendChild(b);a.removeChild(document.getElementById("signupbtn"))}function formLogin(){var a=document.createElement("div");a.setAttribute("class","form");a.setAttribute("id","form-login");var d=document.createElement("input");d.setAttribute("type","text");d.setAttribute("name","username-login");d.setAttribute("maxlength","50");d.setAttribute("placeholder","User Name");var b=document.createElement("input");b.setAttribute("type","password");b.setAttribute("name","password-login");b.setAttribute("maxlength","32");b.setAttribute("placeholder","Password");var c=document.createElement("button");c.setAttribute("type","button");c.setAttribute("name","submit-login");c.setAttribute("onclick","login();");c.innerHTML="Log In";a.appendChild(d);a.appendChild(b);a.appendChild(c);return a}function formSignUp(){var h=document.createElement("div");h.setAttribute("class","form");h.setAttribute("id","form-signup");var g=document.createElement("input");g.setAttribute("type","text");g.setAttribute("name","username-signup");g.setAttribute("maxlength","50");g.setAttribute("placeholder","User Name");var e=document.createElement("input");e.setAttribute("type","text");e.setAttribute("name","email-signup");e.setAttribute("maxlength","50");e.setAttribute("placeholder","Email - optional");var a=document.createElement("input");a.setAttribute("type","text");a.setAttribute("name","phone-signup");a.setAttribute("maxlength","15");a.setAttribute("placeholder","Phone - optional");var d=document.createElement("input");d.setAttribute("type","password");d.setAttribute("name","password-signup");d.setAttribute("maxlength","32");d.setAttribute("placeholder","Password");var c=document.createElement("input");c.setAttribute("type","password");c.setAttribute("name","password-signup-check");c.setAttribute("maxlength","32");c.setAttribute("placeholder","Repeat Password");var f=document.createElement("button");f.setAttribute("type","button");f.setAttribute("value","submit-signup");f.setAttribute("onclick","signup();");f.innerHTML="Sign Up";var b=document.createElement("div");b.setAttribute("class","error");b.setAttribute("id","error-signup");h.appendChild(g);h.appendChild(e);h.appendChild(a);h.appendChild(d);h.appendChild(c);h.appendChild(f);h.appendChild(b);return h}function loadTempPage(a){var b=createURL("/editpage?page="+a+"&temp=true");window.location=b}function loadPermPage(a){var b=createURL("/editpage?page="+a+"&temp=false");window.location=b}function progressFinalize(b,a){document.getElementById("progressbar").setAttribute("value",a);document.getElementById("progressbar").style.visibility="hidden";document.getElementById("progressbar").style.display="none";document.getElementById("autosave").style.visibility="visible";document.getElementById("autosave").style.display="block";document.getElementById("savestatus").innerHTML=b}function progressInitialize(b,a){document.getElementById("autosave").style.visibility="hidden";document.getElementById("autosave").style.display="none";document.getElementById("progressbar").setAttribute("value",0);document.getElementById("progressbar").setAttribute("max",a);document.getElementById("progressbar").style.visibility="visible";document.getElementById("progressbar").style.display="block";document.getElementById("savestatus").innerHTML=b}function progressUpdate(a){document.getElementById("progressbar").setAttribute("value",a)}function rowProfileCheck(a,i,h,j){var l=document.createElement("div");l.setAttribute("class","row");var k=document.createElement("div");k.setAttribute("class","col col-15");var d=document.createElement("div");d.setAttribute("class","col col-35 pad-10-left");var f=document.createElement("div");f.setAttribute("class","col col-35 pad-10-right");var c=document.createElement("div");c.setAttribute("class","col col-15");var e=document.createElement("input");e.setAttribute("type","password");e.setAttribute("name",a);e.setAttribute("class","text-input");e.setAttribute("maxlength","50");e.setAttribute("placeholder",h[0]);var b=document.createElement("input");b.setAttribute("type","password");b.setAttribute("name",i);b.setAttribute("class","text-input");b.setAttribute("maxlength","50");b.setAttribute("placeholder",h[1]);var g=document.createElement("button");g.setAttribute("type","button");g.setAttribute("name","save-"+i);g.setAttribute("class","menubtn save-btn");g.setAttribute("onclick",'saveProfileInfo(this,["'+a+'","'+i+'"])');g.innerHTML="Save";k.innerHTML=j;d.appendChild(e);f.appendChild(b);c.appendChild(g);l.appendChild(k);l.appendChild(d);l.appendChild(f);l.appendChild(c);return l}function rowProfileSingle(f,g,c){var i=document.createElement("div");i.setAttribute("class","row");var h=document.createElement("div");h.setAttribute("class","col col-15");var e=document.createElement("div");e.setAttribute("class","col col-70 pad-10");var b=document.createElement("div");b.setAttribute("class","col col-15");var a=document.createElement("input");a.setAttribute("type","text");a.setAttribute("name",f);a.setAttribute("class","text-input");a.setAttribute("maxlength","50");a.setAttribute("value",c);var d=document.createElement("button");d.setAttribute("type","button");d.setAttribute("name","save-"+f);d.setAttribute("class","menubtn save-btn");d.setAttribute("onclick",'saveProfileInfo(this,["'+f+'"])');d.innerHTML="Save";h.innerHTML=g;e.appendChild(a);b.appendChild(d);i.appendChild(h);i.appendChild(e);i.appendChild(b);return i}function pageChoose(f){var j=document.createElement("div");j.setAttribute("class","row");var h=document.createElement("div");h.setAttribute("class","col col-100 pad-10");var i=document.createElement("p");i.innerHTML="You are viewing this because the page was closed without Revert or Save being clicked. Please choose which page you want to save.";h.appendChild(i);j.appendChild(h);var c=document.createElement("div");c.setAttribute("class","row");var l=document.createElement("div");l.setAttribute("class","col col-50 pad-10");var b=document.createElement("div");b.setAttribute("class","col col-50 pad-10");c.appendChild(l);c.appendChild(b);var k=document.createElement("p");k.innerHTML="This is your last temporary save. This save contains the blocks from the last time you added a block.";var e=document.createElement("button");e.setAttribute("type","button");e.setAttribute("class","menubtn temp-btn");e.setAttribute("value","submit-temp");e.setAttribute("onclick","loadTempPage("+f+");");e.innerHTML="Temporary Page";var a=document.createElement("p");a.innerHTML="This is you last permanent save. This save contains the blocks from the last time you clicked Save.";var g=document.createElement("button");g.setAttribute("type","button");g.setAttribute("class","menubtn perm-btn");g.setAttribute("value","submit-perm");g.setAttribute("onclick","loadPermPage("+f+");");g.innerHTML="Permanent Page";l.appendChild(e);l.appendChild(k);b.appendChild(g);b.appendChild(a);var d=document.getElementById("content");d.appendChild(j);d.appendChild(c)}function pageEdit(y){var P=document.createElement("div");P.setAttribute("class","block-menu");var k=document.createElement("div");k.setAttribute("class","row");var E=document.createElement("div");E.setAttribute("class","col col-15");var O=document.createElement("div");O.setAttribute("class","col col-70 pad-10");var x=document.createElement("div");x.setAttribute("class","col col-15");k.appendChild(E);k.appendChild(O);k.appendChild(x);var t=btnLogOut();var q=dashSaveBar();var s=dashSaveProgress();var p=dashSaveStatus();var H=dashAutoSave();var w=document.createElement("div");w.setAttribute("id","saveinfo");w.appendChild(p);s.appendChild(H);q.appendChild(s);q.appendChild(w);var g=btnProfile();var F=y.split(",");var G=F[0];var L=F[1];var z=document.createElement("input");z.setAttribute("type","hidden");z.setAttribute("name","pageid");z.setAttribute("value",G);var T=document.createElement("input");T.setAttribute("type","hidden");T.setAttribute("name","statusid");T.setAttribute("value","1");E.appendChild(t);O.appendChild(q);x.appendChild(g);P.appendChild(z);P.appendChild(T);P.appendChild(k);var C=document.createElement("div");C.setAttribute("class","row");var A=document.createElement("div");A.setAttribute("class","col col-15");var I=document.createElement("div");I.setAttribute("class","col col-70 pad-10");var b=document.createElement("div");b.setAttribute("class","col col-15");C.appendChild(A);C.appendChild(I);C.appendChild(b);var R=document.createElement("button");R.setAttribute("type","button");R.setAttribute("name","revert-blocks");R.setAttribute("class","menubtn revert-btn");R.setAttribute("onclick","revertBlocks()");R.innerHTML="Revert";var D=document.createElement("input");D.setAttribute("type","text");D.setAttribute("name","pagename");D.setAttribute("class","page-title");D.setAttribute("maxlength","50");D.setAttribute("value",L);var h=document.createElement("button");h.setAttribute("type","button");h.setAttribute("name","save-blocks");h.setAttribute("class","menubtn save-btn");h.setAttribute("onclick","saveBlocks(true)");h.innerHTML="Save";A.appendChild(R);I.appendChild(D);b.appendChild(h);P.appendChild(C);var v=document.createElement("div");v.setAttribute("class","blocks");v.setAttribute("id","blocks");var B=blockButtons(0);v.appendChild(B);var K=2;var M=1;while(K<F.length){var l=insertContent(M,F[K],F[K+1]);B=blockButtons(M);var u=document.createElement("div");u.setAttribute("class","block");u.setAttribute("id",M);u.appendChild(l);u.appendChild(B);v.appendChild(u);K+=2;M++}var f=document.createElement("input");f.setAttribute("type","file");f.setAttribute("id","file-select");var S=document.createElement("button");S.setAttribute("type","submit");S.setAttribute("id","upload-button");var e=createURL("/uploadmedia");var a=document.createElement("form");a.setAttribute("id","file-form");a.setAttribute("action",e);a.setAttribute("method","POST");a.style.visibility="hidden";a.appendChild(f);a.appendChild(S);var d=document.getElementById("content");d.appendChild(P);d.appendChild(v);d.appendChild(a);M=0;var c=countBlocks();while(M<c){document.getElementById("d"+M).style.visibility="visible";M++}document.getElementById("d"+M).style.visibility="hidden";var J=document.getElementsByClassName("xTex");var j=J.length;for(M=0;M<j;M++){J[M].contentDocument.designMode="on"}var N=document.getElementsByTagName("code");var r=N.length;for(M=0;M<r;M++){renderCode(N[M])}var o=document.getElementsByClassName("xmath");var m=o.length;for(M=0;M<m;M++){insertMath(o[M])}var Q=document.getElementsByClassName("latex");var n=Q.length;for(M=0;M<n;M++){insertLatex(Q[M])}autosaveTimer(H);window.onbeforeunload=function(){var i=document.getElementsByName("statusid")[0].value;if(i==0){return"Please click Revert or Save before exiting."}return null}}function pageError(c){var b=document.createElement("div");if(c==="noeditloggedout"){b.innerHTML="You Cannot Edit The Requested Page Because You Are Logged Out."}else{if(c==="notfound"){b.innerHTML="There URL You Requested Does Not Exist"}}var a=document.getElementById("content");a.appendChild(b)}function pageHome(){var n=document.createElement("div");n.setAttribute("class","row");var o=document.createElement("div");o.setAttribute("class","col col-15");var b=document.createElement("div");b.setAttribute("class","col col-70 pad-10");var l=document.createElement("div");l.setAttribute("class","col col-15");n.appendChild(o);n.appendChild(b);n.appendChild(l);var i=btnLogOut();var g=btnProfile();o.appendChild(g);l.appendChild(i);var c=document.createElement("div");c.setAttribute("class","row");var e=document.createElement("div");e.setAttribute("class","col col-60");var f=document.createElement("div");f.setAttribute("class","col col-25");var h=document.createElement("div");h.setAttribute("class","col col-15");c.appendChild(e);c.appendChild(f);c.appendChild(h);var m=document.createElement("input");m.setAttribute("type","text");m.setAttribute("class","text-input");m.setAttribute("name","pagename-create");m.setAttribute("maxlength","50");m.setAttribute("placeholder","Page Name");var k=document.createElement("select");var a=getTopics();a.then(function(v){var r=JSON.parse(v);var s=Object.keys(r);var q=s.length;for(var t=0;t<q;t++){var u=document.createElement("option");u.setAttribute("value",s[t]);u.innerHTML=s[t];k.appendChild(u)}console.log(k)},function(q){console.log("getTopics promise error: "+q)});var j=btnSubmit("Create Page","createpage");e.appendChild(m);h.appendChild(j);var d=document.getElementById("content");d.appendChild(n);d.appendChild(c);var p=getPages();p.then(function(t){var x=t.split(",");var s=document.createElement("div");s.setAttribute("class","row");var r=document.createElement("div");r.setAttribute("class","col col-100");var v=document.createElement("div");v.setAttribute("class","pagelist");s.appendChild(v);var B=document.createElement("select");B.setAttribute("multiple","true");B.setAttribute("class","select-multiple");B.setAttribute("id","page-select");v.appendChild(B);var A=document.createElement("div");A.setAttribute("class","row");var z=document.createElement("div");z.setAttribute("class","col col-100");var q=btnSubmit("Go To Page","goToPage");v.appendChild(q);var y;if(x.length===1){y=0}else{y=x.length/2}var u=0;while(y>0){var w=document.createElement("option");w.setAttribute("value",x[u]);w.innerHTML=x[u+1];B.appendChild(w);u+=2;y--}d.appendChild(document.createElement("hr"));d.appendChild(v)},function(q){console.log("getPages promise error")})}function pageLanding(){var b=formLogin();var c=document.createElement("button");c.setAttribute("type","button");c.setAttribute("id","signupbtn");c.setAttribute("onclick","displaySignUp();");c.innerHTML="Sign Up";var a=document.getElementById("content");a.appendChild(b);a.appendChild(document.createElement("hr"));a.appendChild(c)}function pageProfile(b){if(b==="err"){console.log("profile error")}else{if(b==="noprofileloggedout"){console.log("profile logged out")}}var m=JSON.parse(b);var c=document.createElement("div");c.setAttribute("class","block-menu");var a=document.createElement("div");a.setAttribute("class","row");var j=document.createElement("div");j.setAttribute("class","col col-15");var h=document.createElement("div");h.setAttribute("class","col col-70 pad-10");var n=document.createElement("div");n.setAttribute("class","col col-15");a.appendChild(j);a.appendChild(h);a.appendChild(n);var o=btnLogOut();j.appendChild(o);c.appendChild(a);var f=document.createElement("div");f.setAttribute("class","profilelist");var l=rowProfileSingle("username","Username:",m.username);var e=rowProfileCheck("currentPass","newPass",["Current Password","New Password"],"Password:");var d=rowProfileSingle("autosave","Auto Save:",m.autosave);var k=rowProfileSingle("email","Email:",m.email);var i=rowProfileSingle("phone","Phone:",m.phone);f.appendChild(l);f.appendChild(e);f.appendChild(d);f.appendChild(k);f.appendChild(i);var g=document.getElementById("content");g.appendChild(c);g.appendChild(f)}function countBlocks(){var a=0;var b=true;while(b===true){a++;b=Boolean(document.getElementById(a))}return --a}function generateBlock(a,c){var b=document.createElement("div");b.setAttribute("class",c);b.setAttribute("id","a"+a);return b}function insertContent(n,i,k){var f=generateBlock(n,i);if(i==="xtext"){var h=document.createElement("iframe");h.setAttribute("class","xTex");h.setAttribute("maxlength","1023");f.appendChild(h);setTimeout(function(){var s=document.createElement("link");s.href="http://abaganon.com/css/block.css";s.rel="stylesheet";s.type="text/css";var t=f.childNodes[0].contentDocument;t.open();t.write(k);t.close();f=f.childNodes[0];if(t.addEventListener){t.addEventListener("keydown",detectKey.bind(null,f),false)}else{if(t.attachEvent){t.attachEvent("onkeydown",detectKey.bind(null,f))}else{t.onkeydown=detectKey.bind(null,f)}}},1)}else{if(i==="xcode"){var c=document.createElement("code");c.setAttribute("class","xCde");c.setAttribute("onblur","renderCode(this)");c.contentEditable="true";c.innerHTML=k;f.appendChild(c);if(c.addEventListener){c.addEventListener("keydown",codeKeys.bind(null,f),false)}else{if(c.attachEvent){c.attachEvent("onkeydown",codeKeys.bind(null,f))}else{c.onkeydown=codeKeys.bind(null,f)}}}else{if(i==="xmath"){var q='<div class="mathImage"></div>';var a='<div class="xMat" onblur="renderMath(this);" contenteditable>'+k+"</code>";f.innerHTML=q+a}else{if(i==="latex"){var o='<div class="latexImage"></div>';var l='<div class="xLtx" onblur="renderLatex(this);" contenteditable>'+k+"</code>";f.innerHTML=o+l}else{if(i==="image"){var p=document.createElement("img");p.setAttribute("class","xImg");p.src=k;f.appendChild(p)}else{if(i==="audio"){var r=document.createElement("audio");r.setAttribute("class","xAud");r.volume=0.8;r.setAttribute("controls","controls");var d=document.createElement("source");d.setAttribute("src",k);d.setAttribute("type","audio/mpeg");r.appendChild(d);f.appendChild(r)}else{if(i==="video"){var m=document.createElement("video");m.setAttribute("class","xVid");m.volume=0.8;m.setAttribute("controls","controls");var g=document.createElement("source");g.setAttribute("src",k);g.setAttribute("type","video/mp4");m.appendChild(g);f.appendChild(m)}else{if(i==="xsvgs"){var b=document.createElement("div");b.setAttribute("class","xSvg");b.setAttribute("data-link",k);if(k!==""){getLocalLinkContent(k).then(function(t){var s=t.split("\n");b.innerHTML=s[1]},function(s){})}f.appendChild(b)}else{if(i==="slide"){var e=document.createElement("canvas");e.setAttribute("class","xSli");e.setAttribute("id",k);e.setAttribute("data-page","1");f.appendChild(e);if(k!==""){PDFJS.getDocument(k).then(function(t){pdfObjects[k]=t;var s=f.childNodes[0];renderPDF(t,1,s)})}f.onmouseup=function(u){var x=u.pageX-this.offsetLeft;var t=this.childNodes[0];var v=t.getAttribute("data-page");var w=t.getAttribute("id");var s=pdfObjects[w].numPages;if(x>this.offsetWidth/1.7){if(v<s){v++;t.setAttribute("data-page",v);renderPDF(pdfObjects[w],v,t)}}else{if(v>1){v--;t.setAttribute("data-page",v);renderPDF(pdfObjects[w],v,t)}}}}else{if(i==="title"){var j='<input type="text" class="xTit" maxlength="64" value="'+k+'">';f.innerHTML=j}}}}}}}}}}return f}function codeKeys(e,b){if(b.keyCode===9){b.preventDefault();var d=e.ownerDocument.defaultView;var c=d.getSelection();var a=c.getRangeAt(0);var f=document.createTextNode("\u00a0\u00a0\u00a0\u00a0");a.insertNode(f);a.setStartAfter(f);a.setEndAfter(f);c.removeAllRanges();c.addRange(a)}}function detectKey(a,b){if(b.shiftKey&&b.ctrlKey&&b.keyCode===66){a.contentDocument.execCommand("bold",false,null)}if(b.shiftKey&&b.ctrlKey&&b.keyCode===73){a.contentDocument.execCommand("italic",false,null)}if(b.shiftKey&&b.ctrlKey&&b.keyCode===76){a.contentDocument.execCommand("insertUnorderedList",false,null)}if(b.shiftKey&&b.ctrlKey&&b.keyCode===187){a.contentDocument.execCommand("superscript",false,null)}if(b.shiftKey&&b.ctrlKey&&b.keyCode===189){a.contentDocument.execCommand("subscript",false,null)}if(b.shiftKey&&b.ctrlKey&&b.keyCode===74){a.contentDocument.execCommand("justifyLeft",false,null)}if(b.shiftKey&&b.ctrlKey&&b.keyCode===70){a.contentDocument.execCommand("justifyFull",false,null)}if(b.keyCode===9){a.contentDocument.execCommand("insertHTML",false,"&nbsp;&nbsp;&nbsp;&nbsp;")}if(b.shiftKey&&b.ctrlKey&&b.keyCode===72){var c=function(d,e){if(d){if(e.indexOf("http://")<0&&e.indexOf("https://")<0){a.contentDocument.execCommand("createLink",false,"http://"+e)}else{if(e.indexOf("http://")>0||e.indexOf("https://")>0){a.contentDocument.execCommand("createLink",false,e)}else{alertify.log("Not A Valid Link!","error")}}}else{}};alertify.prompt("Enter the link: ",c,"http://")}b.stopPropagation()}function renderCode(a){hljs.highlightBlock(a);if(a.textContent.length>1024){alertify.alert("There is too much in this code block. The block will not save correctly. Please remove some of its content.")}}function renderMath(c){var b="`"+c.textContent+"`";var a=c.parentNode.childNodes[0];a.innerHTML=b;MathJax.Hub.Queue(["Typeset",MathJax.Hub,a])}function renderLatex(c){var b="$$"+c.textContent+"$$";var a=c.parentNode.childNodes[0];a.innerHTML=b;MathJax.Hub.Queue(["Typeset",MathJax.Hub,a])}function renderPDF(a,c,b){var d=0.8;a.getPage(c).then(function(h){var e=h.getViewport(d);b.height=e.height;b.width=e.width;var g={canvasContext:b.getContext("2d"),viewport:e};var f=h.render(g);f.promise.then(function(){})})}function insertMath(c){var b="`"+c.childNodes[1].textContent+"`";var a=c.childNodes[0];a.innerHTML=b;MathJax.Hub.Queue(["Typeset",MathJax.Hub,a])}function insertLatex(c){var b="$$"+c.childNodes[1].textContent+"$$";var a=c.childNodes[0];a.innerHTML=b;MathJax.Hub.Queue(["Typeset",MathJax.Hub,a])}function blockButtons(f){var j=document.createElement("div");j.setAttribute("class","blockbtns");j.setAttribute("id","b"+f);var a=document.createElement("button");a.setAttribute("onclick","addBlock("+f+",'xtext')");a.setAttribute("class","blockbtn addbtn");a.innerHTML="text";var g=document.createElement("button");g.setAttribute("onclick","addBlock("+f+",'xcode')");g.setAttribute("class","blockbtn addbtn");g.innerHTML="code";var m=document.createElement("button");m.setAttribute("onclick","addBlock("+f+",'xmath')");m.setAttribute("class","blockbtn addbtn");m.innerHTML="math";var l=document.createElement("button");l.setAttribute("onclick","addBlock("+f+",'latex')");l.setAttribute("class","blockbtn addbtn");l.innerHTML="latex";var b=document.createElement("button");b.setAttribute("onclick","addBlock("+f+",'image')");b.setAttribute("class","blockbtn addbtn");b.innerHTML="image";var i=document.createElement("button");i.setAttribute("onclick","addBlock("+f+",'audio')");i.setAttribute("class","blockbtn addbtn");i.innerHTML="audio";var c=document.createElement("button");c.setAttribute("onclick","addBlock("+f+",'video')");c.setAttribute("class","blockbtn addbtn");c.innerHTML="video";var h=document.createElement("button");h.setAttribute("onclick","addBlock("+f+",'slide')");h.setAttribute("class","blockbtn addbtn");h.innerHTML="slides";var d=document.createElement("button");d.setAttribute("onclick","addBlock("+f+",'xsvgs')");d.setAttribute("class","blockbtn addbtn");d.innerHTML="svg";var e=document.createElement("button");e.setAttribute("onclick","addBlock("+f+",'title')");e.setAttribute("class","blockbtn addbtn");e.innerHTML="title";var k=document.createElement("button");k.setAttribute("id","d"+f);k.setAttribute("onclick","deleteBlock("+f+")");k.setAttribute("class","blockbtn delbtn");k.style.visibility="hidden";k.innerHTML="&darr;";j.appendChild(a);j.appendChild(g);j.appendChild(m);j.appendChild(l);j.appendChild(b);j.appendChild(i);j.appendChild(c);j.appendChild(d);j.appendChild(e);j.appendChild(k);return j}function makeSpace(b,e){var a=e;while(b<a){var c=a+1;var d=blockButtons(c);document.getElementById("b"+a).parentNode.replaceChild(d,document.getElementById("b"+a));document.getElementById("a"+a).setAttribute("id","a"+c);document.getElementById(a).setAttribute("id",c);a--}}function insertBlock(g,d,b,c){var f=document.getElementById("blocks");var e=document.createElement("div");e.setAttribute("class","block");e.setAttribute("id",b);e.appendChild(g);e.appendChild(d);if(b<=c){var a=document.getElementById("blocks").children[b];document.getElementById("blocks").insertBefore(e,a)}else{f.appendChild(e)}}function createBlock(c,h){var f=countBlocks();if(c<f){makeSpace(c,f)}var b=c+1;var e="";var g=insertContent(b,h,e);var a=blockButtons(b);insertBlock(g,a,b,f);var d=0;while(d<=f){document.getElementById("d"+d).style.visibility="visible";d++}}function addBlock(a,d){if(d==="xtext"){createBlock(a,d);var c=document.getElementById("a"+(a+1)).childNodes[0];var b=c.contentDocument;b.designMode="on";saveBlocks(false)}else{if(["xcode","xmath","latex","title"].indexOf(d)>-1){createBlock(a,d);saveBlocks(false)}else{if(["image","audio","video","slide","xsvgs"].indexOf(d)>-1){uploadMedia(a+1,d)}}}}function closeSpace(b,e){var a=b;while(a<e){var c=a+1;var d=blockButtons(a);document.getElementById("b"+c).parentNode.replaceChild(d,document.getElementById("b"+c));document.getElementById("a"+c).setAttribute("id","a"+a);document.getElementById(c).setAttribute("id",a);a++}}function removeBlock(a){var b=document.getElementById(a);b.parentNode.removeChild(b)}function deleteBlock(b){var d=countBlocks();var a=b+1;removeBlock(a);if(a<d){closeSpace(a,d)}var c=0;d=countBlocks();while(c<d){document.getElementById("d"+c).style.visibility="visible";c++}document.getElementById("d"+c).style.visibility="hidden";saveBlocks(false)}function uploadMedia(b,c){var a=document.getElementById("file-select");switch(c){case"image":a.setAttribute("accept",".bmp,.bmp2,.bmp3,.jpeg,.jpg,.pdf,.png,.svg");break;case"audio":a.setAttribute("accept",".aac,.aiff,.m4a,.mp3,.ogg,.ra,.wav,.wma");break;case"video":a.setAttribute("accept",".avi,.flv,.mov,.mp4,.mpeg,.ogg,.rm,.webm,.wmv");break;case"xsvgs":a.setAttribute("accept",".svg");break;case"slide":a.setAttribute("accept",".pdf,.ppt,.pptx,.pps,.ppsx");break;default:a.setAttribute("accept","")}a.click();a.onchange=function(){var e=a.files[0];var h=false;var d=false;var f;if(a.files.length>0){if(e.size>4294967295){h=true;f="Files Must Be Less Than 4.3 GB"}}else{d=true}if(d){console.log("nofile")}else{if(h){alertify.alert(f)}else{createBlock(b-1,c);var g=new Promise(function(o,n){var p=new FormData();p.append("media",e,e.name);var k=document.getElementsByName("pageid")[0].value;var l=createURL("/uploadmedia?pid="+k+"&btype="+c);var m=new XMLHttpRequest();m.open("POST",l,true);m.upload.onloadstart=function(q){progressInitialize("Uploading...",q.total)};m.upload.onprogress=function(q){if(q.lengthComputable){progressUpdate(q.loaded)}};m.upload.onloadend=function(q){progressFinalize("Uploaded",q.total)};function j(q){if(typeof j.track==="undefined"||j.track===0){j.track=1;return 1}else{if(q){j.track=0;return 0}else{j.track++}}return j.track}function i(q){if(typeof i.prev==="undefined"){i.prev=0;i.curr=q}else{if(i.curr!==q){i.prev=i.curr;i.curr=q}}return[i.prev,i.curr]}m.onprogress=function(s){var q=i(m.responseText.length);var r=j(false);var t=m.responseText.slice(q[0],q[1]).split(",");if(r===1){progressInitialize("Converting...",t[t.length-1])}else{progressUpdate(t[t.length-1])}};m.onloadend=function(r){var q=i(m.responseText.length);var s=m.responseText.slice(q[0],q[1]).split(",");progressFinalize("Not Saved",s[s.length-1]);j(true)};m.onreadystatechange=function(){if(m.readyState===XMLHttpRequest.DONE){if(m.status===200){if(m.responseText==="err"){n("err")}else{if(m.responseText==="convertmediaerr"){n("convertmediaerr")}else{if(m.responseText==="nouploadloggedout"){deleteBlock(b-1);alertify.alert("You Can't Upload Media Because You Are Logged Out. Log Back In On A Separate Page, Then Return Here & Try Again.");n("err")}else{var q=i(m.responseText.length);var r=m.responseText.slice(q[0],q[1]).split(",");i(0);i(0);o(r[r.length-1])}}}}else{alertify.alert("Error:"+m.status+": Please Try Again");n("err")}}};m.send(p)});g.then(function(l){if(c==="image"){var k=document.getElementById("a"+b).childNodes[0];k.src=l}else{if(c==="audio"||c==="video"){var j=document.getElementById("a"+b).childNodes[0].childNodes[0];j.src=l;j.parentNode.load()}else{if(c==="xsvgs"){var i=document.getElementById("a"+b).childNodes[0];i.setAttribute("data-link",l);getLocalLinkContent(l).then(function(n){var m=n.split("\n");i.innerHTML=m[1]},function(m){})}else{if(c==="slide"){PDFJS.getDocument(l).then(function(m){pdfObjects[l]=m;var n=document.getElementById("a"+b).childNodes[0];n.setAttribute("id",l);renderPDF(m,1,n)})}}}}saveBlocks(false)},function(i){if(i==="convertmediaerr"){alertify.log("There was an error with that media format. Please try a different file type.")}else{console.log("uploadMedia() promise error")}})}}this.value=null}}function login(){var b=createURL("/login");var e=document.getElementsByName("username-login")[0].value;var a=document.getElementsByName("password-login")[0].value;var c;c=new XMLHttpRequest();var d="username="+e+"&password="+a;c.open("POST",b,true);c.setRequestHeader("Content-type","application/x-www-form-urlencoded");c.onreadystatechange=function(){if(c.readyState===XMLHttpRequest.DONE){if(c.status===200){if(c.responseText==="loggedin"){emptyDiv("content");pageHome()}else{if(c.responseText==="incorrect"){alertify.alert("The Passowrd Was Incorrect")}else{if(c.responseText==="notfound"){alertify.alert("The Username Could Not Be Found")}else{alertify.alert("An Unknown Error Occurred")}}}}else{alertify.alert("Error:"+c.status+": Please Try Again Later")}}};c.send(d)}function signup(){var d=createURL("/signup");var h=document.getElementsByName("username-signup")[0].value;var c=document.getElementsByName("email-signup")[0].value;var a=document.getElementsByName("phone-signup")[0].value;var b=document.getElementsByName("password-signup")[0].value;var f=document.getElementsByName("password-signup-check")[0].value;if(b!==f){}var e;e=new XMLHttpRequest();var g="username="+h+"&email="+c+"&phone="+a+"&password="+b;e.open("POST",d,true);e.setRequestHeader("Content-type","application/x-www-form-urlencoded");e.onreadystatechange=function(){if(e.readyState===XMLHttpRequest.DONE){if(e.status===200){if(e.responseText==="success"){emptyDiv("content");pageHome()}else{if(e.responseText==="exists"){alertify.alert("That Username Already Exists.\nPlease Choose A Different One.")}else{alertify.alert("An Unknown Error Occurred")}}}else{alertify.alert("Error:"+e.status+": Please Try Again Later")}}};e.send(g)}function logout(){var a=createURL("/logout");var b;b=new XMLHttpRequest();b.open("POST",a,true);b.setRequestHeader("Content-type","application/x-www-form-urlencoded");b.onreadystatechange=function(){if(b.readyState===XMLHttpRequest.DONE){if(b.status===200){if(b.responseText==="loggedout"){emptyDiv("content");pageLanding()}else{alertify.alert("An Unknown Error Occurred")}}else{alertify.alert("Error:"+b.status+": Please Try Again Later")}}};b.send()}function createpage(){var b=createURL("/createpage");var a=document.getElementsByName("pagename-create")[0].value;var c;c=new XMLHttpRequest();var d="pagename="+a;c.open("POST",b,true);c.setRequestHeader("Content-type","application/x-www-form-urlencoded");c.onreadystatechange=function(){if(c.readyState===XMLHttpRequest.DONE){if(c.status===200){if(c.responseText==="pageexists"){alertify.alert("You Already Have A Page With That Name.")}else{if(c.responseText==="nocreateloggedout"){alertify.alert("Unable To Create Page. You Are Logged Out.")}else{if(c.responseText==="err"){alertify.alert("An Error Occured. Please Try Again Later.")}else{window.location=createURL("/editpage?page="+c.responseText)}}}}else{alertify.alert("Error:"+c.status+": Please Try Again Later")}}};c.send(d)}function getPages(){var a=new Promise(function(e,d){var b=createURL("/getpages");var c;c=new XMLHttpRequest();c.open("POST",b,true);c.setRequestHeader("Content-type","application/x-www-form-urlencoded");c.onreadystatechange=function(){if(c.readyState===XMLHttpRequest.DONE){if(c.status===200){if(c.responseText==="err"){d("err")}else{e(c.responseText)}}else{alertify.alert("Error:"+c.status+": Please Try Again Later")}}};c.send()});return a}function getTopics(){var a=new Promise(function(e,d){var b=createURL("/gettopics");var c;c=new XMLHttpRequest();c.open("POST",b,true);c.setRequestHeader("Content-type","application/x-www-form-urlencoded");c.onreadystatechange=function(){if(c.readyState===XMLHttpRequest.DONE){if(c.status===200){if(c.responseText==="err"){d("err")}else{e(c.responseText)}}else{alertify.alert("Error:"+c.status+": Please Try Again Later")}}};c.send()});return a}function saveBlocks(g){var p;if(g===false){p=0;document.getElementById("savestatus").innerHTML="Not Saved"}else{p=1;document.getElementById("savestatus").innerHTML="Saved"}document.getElementsByName("statusid")[0].setAttribute("value",p);var r=[];var e=[];var l=countBlocks();var o=1;if(l>0){var m=0;while(l>=o){var k=document.getElementById("a"+o).className;r[m]=k;if(k==="xtext"){e[m]=document.getElementById("a"+o).children[0].contentDocument.getElementsByTagName("body")[0].innerHTML;e[m]=e[m].replace(/'/g," ").replace(/,/g," ").replace(/&/g," ")}else{if(k==="xcode"){e[m]=document.getElementById("a"+o).children[0].textContent;e[m]=e[m].replace(/'/g," ").replace(/,/g," ").replace(/&/g," ")}else{if(k==="latex"||k==="xmath"){e[m]=document.getElementById("a"+o).children[1].innerHTML.replace(/\\/g,"\\\\");e[m]=e[m].replace(/'/g," ").replace(/,/g," ").replace(/&/g," ")}else{if(k==="image"){var a=document.getElementById("a"+o).children[0].src;e[m]=a.replace(location.href.substring(0,location.href.lastIndexOf("/")+1),"")}else{if(k==="audio"||k==="video"){var h=document.getElementById("a"+o).children[0].children[0].src;e[m]=h.replace(location.href.substring(0,location.href.lastIndexOf("/")+1),"")}else{if(k==="xsvgs"){var s=document.getElementById("a"+o).childNodes[0].getAttribute("data-link");e[m]=s.replace(location.href.substring(0,location.href.lastIndexOf("/")+1),"")}else{if(k==="slide"){var c=document.getElementById("a"+o).children[0].id;e[m]=c.replace(location.href.substring(0,location.href.lastIndexOf("/")+1),"")}else{if(k==="title"){e[m]=document.getElementById("a"+o).children[0].value;e[m]=e[m].replace(/'/g," ").replace(/,/g," ").replace(/&/g," ")}}}}}}}}m++;o++}var f=r.join();var n=e.join()}var d=createURL("/saveblocks");var j=document.getElementsByName("pageid")[0].value;var b=document.getElementsByName("pagename")[0].value;var t;t=new XMLHttpRequest();if(g!==false){t.upload.onprogress=function(i){if(i.lengthComputable){progressUpdate(i.loaded)}};t.upload.onloadstart=function(i){progressInitialize("Saving...",i.total)};t.upload.onloadend=function(i){progressFinalize("Saved",i.total)}}var q="mediaType="+f+"&mediaContent="+n+"&pid="+j+"&pagename="+b+"&tabid="+p;t.open("POST",d,true);t.setRequestHeader("Content-type","application/x-www-form-urlencoded");t.onreadystatechange=function(){if(t.readyState===XMLHttpRequest.DONE){if(t.status===200){if(t.responseText==="blockssaved"){}else{if(t.responseText==="nosaveloggedout"){alertify.alert("You Can't Save This Page Because You Are Logged Out. Log In On A Separate Page, Then Return Here & Try Again.")}else{alertify.alert("An Unknown Error Occurred")}}}else{alertify.alert("Error:"+t.status+": Please Try Again Later")}}};t.send(q)}function revertBlocks(){var c=createURL("/revert");var a=document.getElementsByName("pageid")[0].value;var b=document.getElementsByName("pagename")[0].value;var d;d=new XMLHttpRequest();var e="pid="+a;d.open("POST",c,true);d.setRequestHeader("Content-type","application/x-www-form-urlencoded");d.onreadystatechange=function(){if(d.readyState===XMLHttpRequest.DONE){if(d.status===200){if(d.responseText==="nopid"){alertify.alert("This Page Is Not Meant To Be Visited Directly.")}else{if(d.responseText==="norevertloggedout"){alertify.alert("Revert Error. You Are Not Logged In.")}else{if(d.responseText==="err"){alertify.alert("An Error Occured. Please Try Again Later")}else{emptyDiv("content");pageEdit(a+","+b+d.responseText)}}}}else{alertify.alert("Error:"+d.status+": Please Try Again Later")}}};d.send(e)}function saveProfileInfo(e,a){var g="";var d=0;var f=a.length;if(f>0){g=a[d]+"="+document.getElementsByName(a[d])[0].value;d++}while(d<f){g+="&"+a[d]+"="+document.getElementsByName(a[d])[0].value;d++}var b=createURL("/saveprofile");var c;c=new XMLHttpRequest();c.open("POST",b,true);c.setRequestHeader("Content-type","application/x-www-form-urlencoded");c.onreadystatechange=function(){if(c.readyState===XMLHttpRequest.DONE){if(c.status===200){if(c.responseText==="profilesaved"){e.style="background-color: #00ffe1";alertify.log("Saved!","success")}else{if(c.responseText==="nosaveloggedout"){e.style="background-color: #e83e3e";alertify.alert("You Can't Save Because You Are Logged Out. Log In On A Separate Page, Then Return Here & Try Again.")}else{e.style="background-color: #e83e3e";alertify.alert("An Unknown Error Occurred")}}}else{alertify.alert("Error:"+c.status+": Please Try Again Later")}}};c.send(g)}function autosaveTimer(a){var b=getUserFields(["autosave"]);b.then(function(d){var e=d.autosave;if(e!=0){var g=e;var c;var f;setInterval(function(){c=parseInt(g/60,10);f=parseInt(g%60,10);c=c<10?"0"+c:c;f=f<10?"0"+f:f;a.textContent=c+":"+f;if(--g<0){saveBlocks(true);g=e}},1000)}else{a.style.visibility="hidden";a.style.display="none"}},function(c){alertify.alert("Error. Auto Save Could Not Be Initiated.")})}function getLocalLinkContent(a){var b=new Promise(function(f,e){var c=createURL("/"+a);var d;d=new XMLHttpRequest();d.open("GET",c,true);d.setRequestHeader("Content-type","application/x-www-form-urlencoded");d.onreadystatechange=function(){if(d.readyState===XMLHttpRequest.DONE){if(d.status===200){if(d.responseText==="err"){e("err")}else{f(d.responseText)}}else{e("err")}}};d.send()});return b}function getUserFields(a){var b=new Promise(function(f,e){var g="fields="+a.join(",");var c=createURL("/getprofiledata");var d;d=new XMLHttpRequest();d.open("POST",c,true);d.setRequestHeader("Content-type","application/x-www-form-urlencoded");d.onreadystatechange=function(){if(d.readyState===XMLHttpRequest.DONE){if(d.status===200){if(d.responseText==="err"){e("err")}else{if(d.responseText==="noprofiledataloggedout"){e("noprofiledataloggedout")}else{f(JSON.parse(d.responseText))}}}else{e("err")}}};d.send(g)});return b};